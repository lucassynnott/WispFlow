{
  "version": 1,
  "project": "WispFlow Improvements & Bugfixes v2",
  "overview": "Improvements, optimizations, and bugfixes for WispFlow, a privacy-focused macOS menu bar application for on-device voice-to-text transcription using WhisperKit. Focus is on stability, user experience polish, and production readiness.",
  "goals": [
    "Harden audio system for reliability across device changes",
    "Improve transcription quality with model selection and language options",
    "Enhance hotkey system with customization and multiple modes",
    "Polish text insertion with smart punctuation and undo support",
    "Create premium, distinctive UI design system",
    "Implement comprehensive error handling and logging",
    "Optimize performance for memory, startup, and battery"
  ],
  "nonGoals": [
    "Cloud-based transcription",
    "Multi-language simultaneous transcription",
    "Real-time translation"
  ],
  "successMetrics": [
    "No crashes when audio devices are plugged/unplugged",
    "App startup within 1 second to visible state",
    "Memory usage under 200MB during idle",
    "All UI components feel distinctive and premium"
  ],
  "openQuestions": [],
  "stack": {
    "framework": "SwiftUI",
    "hosting": "Local macOS app",
    "database": "UserDefaults/Local storage",
    "auth": "N/A - local app"
  },
  "routes": [],
  "uiNotes": [
    "Menu bar app (LSUIElement) - no dock icon",
    "Design philosophy: refined/professional, avoid generic AI aesthetics",
    "Typography first with personality, not Inter/Roboto/SF Pro",
    "Bold color choices - NOT purple gradients or generic blue"
  ],
  "dataModel": [
    { "entity": "AudioDevice", "fields": ["uid", "name", "isDefault", "calibration"] },
    { "entity": "Settings", "fields": ["modelSize", "language", "hotkeyMode", "recordingTimeout"] }
  ],
  "importFormat": {
    "description": "N/A - local app",
    "example": {}
  },
  "rules": [
    "Maximum recording duration 5 minutes (configurable)",
    "Warning toast at 4 minutes",
    "Whisper models: tiny (~39MB), base (~74MB), small (~244MB), medium (~769MB)"
  ],
  "qualityGates": ["swift build"],
  "stories": [
    {
      "id": "US-604",
      "title": "Audio Level Calibration",
      "status": "open",
      "dependsOn": [],
      "description": "As a user, I want to calibrate microphone sensitivity for my environment so that transcription quality is optimal.",
      "acceptanceCriteria": [
        "Add 'Calibrate' button in Audio settings",
        "Measure ambient noise level over 3 seconds when calibrating",
        "Adjust silence threshold based on calibration results",
        "Save calibration per-device using device UID",
        "Provide 'Reset to defaults' option",
        "Example: User clicks Calibrate -> 3-second countdown -> noise measured -> threshold adjusted",
        "Negative case: Calibration during active recording shows error message"
      ]
    },
    {
      "id": "US-605",
      "title": "Whisper Model Selection",
      "status": "open",
      "dependsOn": [],
      "description": "As a user, I want to choose between different Whisper model sizes for speed vs accuracy tradeoff.",
      "acceptanceCriteria": [
        "Add Settings option for model size (tiny, base, small, medium)",
        "Show estimated transcription speed and accuracy for each model",
        "Display download progress indicator when switching models",
        "Persist model preference across restarts in UserDefaults",
        "Example: User selects 'small' model -> download progress shown -> model loaded on completion",
        "Negative case: Network error during download shows retry option"
      ]
    },
    {
      "id": "US-606",
      "title": "Language Selection",
      "status": "open",
      "dependsOn": [],
      "description": "As a user, I want to specify transcription language for better accuracy.",
      "acceptanceCriteria": [
        "Add language dropdown in Settings (Auto-detect + common languages: English, Spanish, French, German, etc.)",
        "Pass language hint to WhisperKit transcription",
        "Remember language preference in UserDefaults",
        "Set 'Auto-detect' as default option",
        "Example: User selects Spanish -> transcription uses Spanish language model",
        "Negative case: Invalid language code falls back to auto-detect"
      ]
    },
    {
      "id": "US-607",
      "title": "Transcription Post-Processing",
      "status": "open",
      "dependsOn": [],
      "description": "As a user, I want transcription output cleaned up for better usability.",
      "acceptanceCriteria": [
        "Add option to auto-capitalize first letter of transcription",
        "Add option to add period at end of sentences",
        "Add option to trim leading/trailing whitespace",
        "Make all options configurable in Settings with toggles",
        "Example: Raw output 'hello world ' -> processed output 'Hello world.'",
        "Negative case: Empty transcription returns empty string (no added punctuation)"
      ]
    },
    {
      "id": "US-608",
      "title": "Retry Failed Transcriptions",
      "status": "open",
      "dependsOn": [],
      "description": "As a user, I want to retry transcription if it fails or produces poor results.",
      "acceptanceCriteria": [
        "Keep last audio buffer in memory after transcription",
        "Show 'Retry' option in error toast notification",
        "Clear buffer after successful insertion or 30-second timeout",
        "Example: Transcription fails -> error toast with Retry button -> user clicks -> re-transcribe same audio",
        "Negative case: Buffer cleared after timeout -> Retry not available"
      ]
    },
    {
      "id": "US-609",
      "title": "Custom Hotkey Configuration",
      "status": "open",
      "dependsOn": [],
      "description": "As a user, I want to configure my own hotkey combination for recording.",
      "acceptanceCriteria": [
        "Add hotkey recorder UI in Settings",
        "Support modifier keys (Cmd, Ctrl, Option, Shift) + any key",
        "Detect and warn about conflicts with common system shortcuts",
        "Default hotkey: Ctrl+Shift+Space",
        "Provide 'Reset to default' button",
        "Store as dictionary: {keyCode: Int, modifiers: Int}",
        "Example: User presses Cmd+Option+R -> hotkey recorded and saved",
        "Negative case: User tries Cmd+Q (system quit) -> conflict warning shown"
      ]
    },
    {
      "id": "US-610",
      "title": "Multiple Hotkey Modes",
      "status": "open",
      "dependsOn": ["US-609"],
      "description": "As a user, I want different recording trigger modes to match my workflow.",
      "acceptanceCriteria": [
        "Implement Push-to-talk mode (hold to record, release to transcribe)",
        "Implement Toggle mode (press to start, press again to stop)",
        "Implement Double-tap mode (double-press to start, single press to stop)",
        "Add mode selector in Settings",
        "Example: Toggle mode selected -> first press starts recording -> second press stops and transcribes",
        "Negative case: Invalid mode in settings defaults to Push-to-talk"
      ]
    },
    {
      "id": "US-611",
      "title": "Hotkey Feedback Sound",
      "status": "open",
      "dependsOn": ["US-609"],
      "description": "As a user, I want optional audio feedback when hotkey is pressed.",
      "acceptanceCriteria": [
        "Play subtle sound on recording start",
        "Play different sound on recording stop",
        "Add toggle in Settings (default: off)",
        "Use system sounds or bundled sound files",
        "Example: User enables feedback -> pressing hotkey plays start sound -> releasing plays stop sound",
        "Negative case: Sound playback fails silently without blocking recording"
      ]
    },
    {
      "id": "US-612",
      "title": "Smart Punctuation Handling",
      "status": "open",
      "dependsOn": [],
      "description": "As a user, I want intelligent punctuation and spacing when text is inserted.",
      "acceptanceCriteria": [
        "Detect if cursor is after a period/space before inserting",
        "Auto-capitalize if starting a new sentence",
        "Add space before insertion if needed",
        "Prevent double-spacing",
        "Example: Cursor after 'Hello.' -> insert ' World' -> result 'Hello. World'",
        "Negative case: Cannot detect cursor context -> insert text as-is"
      ]
    },
    {
      "id": "US-613",
      "title": "Undo Support",
      "status": "open",
      "dependsOn": [],
      "description": "As a user, I want to undo the last text insertion.",
      "acceptanceCriteria": [
        "Cmd+Z after insertion removes inserted text",
        "Restore original clipboard contents after undo",
        "Undo only works within 10 seconds of insertion",
        "Works across different applications",
        "Store inserted text length and target app for undo",
        "Use accessibility API to select and delete",
        "Example: Insert 'Hello World' -> Cmd+Z within 10s -> text removed",
        "Negative case: Undo after 10 seconds -> no action (system undo takes over)"
      ]
    },
    {
      "id": "US-614",
      "title": "Text Insertion Fallback",
      "status": "open",
      "dependsOn": [],
      "description": "As a user, I want fallback options when clipboard-based insertion fails.",
      "acceptanceCriteria": [
        "Detect if paste operation failed (text not inserted)",
        "Try keyboard simulation as fallback method",
        "Show copy-to-clipboard option if all methods fail",
        "Display toast with 'Text copied to clipboard' message",
        "Example: Paste fails in restricted app -> keyboard simulation tried -> success",
        "Negative case: All insertion methods fail -> text copied to clipboard with notification"
      ]
    },
    {
      "id": "US-615",
      "title": "Design System Foundation",
      "status": "open",
      "dependsOn": [],
      "description": "As a developer, I want a cohesive, distinctive design system for WispFlow that feels premium and memorable.",
      "acceptanceCriteria": [
        "Define distinctive color palette (NOT purple gradients, NOT generic blue)",
        "Choose primary color: bold unexpected choice (deep coral, electric teal, warm amber)",
        "Set background: rich dark (#0D0D0D range) or warm off-white (cream/ivory)",
        "Define high-contrast accent color",
        "Define semantic colors for success/warning/error",
        "Select memorable display typography (NOT Inter, Roboto, SF Pro)",
        "Define spacing scale (4px base, consistent rhythm)",
        "Define corner radius philosophy (sharp/brutalist OR soft/organic)",
        "Create SwiftUI Color.Wispflow and Font.Wispflow extensions",
        "Document design tokens in code comments",
        "Example: Color.Wispflow.primary returns the primary brand color",
        "Negative case: Fallback to system colors if custom colors fail to load"
      ]
    },
    {
      "id": "US-616",
      "title": "Settings Window Redesign",
      "status": "open",
      "dependsOn": ["US-615"],
      "description": "As a user, I want a beautifully redesigned Settings window showcasing the design system.",
      "acceptanceCriteria": [
        "Implement bold window chrome with custom title bar or distinctive header",
        "Reimagine tab navigation: vertical sidebar, icon-forward, or segmented control",
        "Use card-based sections with clear visual hierarchy",
        "Apply generous whitespace OR intentional density consistently",
        "Add micro-interactions on hover/focus states",
        "Create custom-styled form controls (toggles, dropdowns, sliders)",
        "Make audio level meter a visual centerpiece with animated waveform",
        "Implement smooth transitions between tabs",
        "Persist window position and size",
        "Example: User opens Settings -> sees premium sidebar navigation -> smooth tab transitions",
        "Negative case: Window state fails to persist -> use default position/size"
      ]
    },
    {
      "id": "US-617",
      "title": "Recording Indicator Redesign",
      "status": "open",
      "dependsOn": ["US-615"],
      "description": "As a user, I want a beautiful, functional recording indicator.",
      "acceptanceCriteria": [
        "Create distinctive floating window design (not generic rounded rect)",
        "Implement real-time waveform visualization with smooth animation",
        "Display recording duration timer with refined typography",
        "Add pulsing/breathing animation that feels alive",
        "Make indicator draggable with smooth physics (momentum)",
        "Apply subtle shadow/glow suggesting depth",
        "Persist position across sessions",
        "Add entry/exit animations (scale + fade or slide)",
        "Example: User starts recording -> indicator appears with scale animation -> waveform animates",
        "Negative case: Position outside screen bounds -> reset to default position"
      ]
    },
    {
      "id": "US-618",
      "title": "Toast Notification System Redesign",
      "status": "open",
      "dependsOn": ["US-615"],
      "description": "As a user, I want distinctive and delightful toast notifications.",
      "acceptanceCriteria": [
        "Apply unique visual style matching design system",
        "Implement smooth spring animations for enter/exit",
        "Support icon + message + optional action button layout",
        "Create different styles for: success, error, warning, info",
        "Implement stacking behavior for multiple toasts",
        "Add click to dismiss with satisfying animation",
        "Make position configurable (all corners + center options)",
        "Show auto-dismiss with subtle progress indicator",
        "Example: Success toast appears -> slides in with spring -> auto-dismisses with fade",
        "Negative case: Too many toasts queued -> oldest dismissed to make room"
      ]
    },
    {
      "id": "US-619",
      "title": "Onboarding Wizard Redesign",
      "status": "open",
      "dependsOn": ["US-615"],
      "description": "As a new user, I want a memorable and confidence-inspiring first-launch experience.",
      "acceptanceCriteria": [
        "Create full-window immersive experience",
        "Use bold hero typography on welcome screen",
        "Design step indicator with personality (not generic dots)",
        "Add illustrations or iconography that feel custom",
        "Implement smooth page transitions with staggered content reveals",
        "Design permission request screens that feel trustworthy",
        "Include audio test step with engaging visualization",
        "Create celebratory completion screen",
        "Target overall flow duration: ~60 seconds",
        "Example: User launches first time -> welcome screen -> permission requests -> audio test -> celebration",
        "Negative case: User skips steps -> still functional with defaults"
      ]
    },
    {
      "id": "US-620",
      "title": "Menu Bar Experience",
      "status": "open",
      "dependsOn": ["US-615"],
      "description": "As a user, I want a polished menu bar icon and dropdown menu.",
      "acceptanceCriteria": [
        "Design icon states: idle, recording (animated pulse), loading, error",
        "Make recording state immediately obvious (color change or animation)",
        "Apply custom styling to dropdown menu if possible",
        "Display status information clearly",
        "Make quick actions easily accessible",
        "Example: Recording active -> menu bar icon pulses red -> dropdown shows 'Recording...'",
        "Negative case: Animation fails -> static icon with color change fallback"
      ]
    },
    {
      "id": "US-621",
      "title": "Transcription Result Display",
      "status": "open",
      "dependsOn": ["US-615"],
      "description": "As a user, I want to see transcription results in a beautiful, scannable way.",
      "acceptanceCriteria": [
        "Create elegant toast or floating panel showing transcribed text",
        "Implement text appearance with typewriter or fade-in effect",
        "Show clear indication of where text was inserted",
        "Add copy button with satisfying feedback",
        "Design error states that feel helpful, not alarming",
        "Handle long text with graceful truncation and expand option",
        "Example: Transcription complete -> result panel slides in -> text types in -> copy button available",
        "Negative case: Very long transcription -> truncated with '...' and expand button"
      ]
    },
    {
      "id": "US-622",
      "title": "Dark/Light Mode Support",
      "status": "open",
      "dependsOn": ["US-615"],
      "description": "As a user, I want both dark and light appearance modes with equally strong design.",
      "acceptanceCriteria": [
        "Design both modes to feel intentional, not auto-generated",
        "Respect system preference with manual override option in Settings",
        "Implement smooth transition when switching modes",
        "Ensure both modes maintain design personality",
        "Test all components in both modes",
        "Example: System switches to dark mode -> app transitions smoothly -> all colors adapt",
        "Negative case: Mode detection fails -> default to system appearance"
      ]
    },
    {
      "id": "US-623",
      "title": "Motion & Animation Polish",
      "status": "open",
      "dependsOn": ["US-615"],
      "description": "As a user, I want cohesive motion design throughout the app.",
      "acceptanceCriteria": [
        "Define animation curves (spring physics preferred)",
        "Apply consistent timing across similar interactions",
        "Add button press states with scale/opacity feedback",
        "Implement list item animations with stagger",
        "Create loading states that feel alive (skeleton, shimmer, or spinner)",
        "Add reduce motion option for accessibility",
        "Example: Button pressed -> scales down slightly -> releases with spring back",
        "Negative case: Reduce motion enabled -> instant state changes, no animations"
      ]
    },
    {
      "id": "US-624",
      "title": "Comprehensive Error Recovery",
      "status": "open",
      "dependsOn": [],
      "description": "As a user, I want graceful handling of all error conditions.",
      "acceptanceCriteria": [
        "Handle audio capture errors with retry using default device",
        "Show error toast with details for transcription errors",
        "Provide direct link to System Settings for permission errors",
        "Offer re-download option for model loading errors",
        "Log all errors for debugging",
        "Example: Audio device disconnected during recording -> auto-switch to default -> continue recording",
        "Negative case: All recovery attempts fail -> show detailed error with support options"
      ]
    },
    {
      "id": "US-625",
      "title": "Crash Reporting & Logging",
      "status": "open",
      "dependsOn": [],
      "description": "As a developer, I want comprehensive logging for debugging user issues.",
      "acceptanceCriteria": [
        "Create log file in ~/Library/Logs/WispFlow/",
        "Implement configurable log level (error, warning, info, debug)",
        "Add log rotation (keep last 5 files, max 10MB each)",
        "Add 'Export Logs' button in Settings",
        "Include system info in logs (macOS version, device info)",
        "Example: User reports bug -> clicks Export Logs -> zip file created with relevant logs",
        "Negative case: Log directory not writable -> log to console only"
      ]
    },
    {
      "id": "US-626",
      "title": "Health Check on Launch",
      "status": "open",
      "dependsOn": [],
      "description": "As a user, I want the app to verify components are working on launch.",
      "acceptanceCriteria": [
        "Check audio system availability on launch",
        "Verify Whisper model integrity",
        "Check required permissions status",
        "Show status in menu bar menu",
        "Alert user if critical issues found",
        "Example: App launches -> checks audio, model, permissions -> all green -> ready status",
        "Negative case: Missing microphone permission -> prompt user with link to System Settings"
      ]
    },
    {
      "id": "US-627",
      "title": "Memory Usage Optimization",
      "status": "open",
      "dependsOn": [],
      "description": "As a user, I want reduced memory footprint for long-running operation.",
      "acceptanceCriteria": [
        "Clear audio buffers after transcription completes",
        "Lazy-load Whisper model on first use",
        "Optionally unload model after period of inactivity",
        "Keep memory usage under 200MB during idle",
        "Example: App idle for 30 minutes -> model unloaded -> memory drops to baseline",
        "Negative case: Model unload fails -> keep in memory, log warning"
      ]
    },
    {
      "id": "US-628",
      "title": "Startup Time Optimization",
      "status": "open",
      "dependsOn": [],
      "description": "As a user, I want fast app launch to ready state.",
      "acceptanceCriteria": [
        "Show app window/menu bar item within 1 second",
        "Load Whisper model in background thread",
        "Show 'Loading model...' status in menu",
        "Defer non-critical initialization",
        "Example: App launched -> menu bar icon visible in <1s -> 'Loading...' shown -> ready in 3s",
        "Negative case: Model takes too long -> show progress indicator"
      ]
    },
    {
      "id": "US-629",
      "title": "Battery Impact Reduction",
      "status": "open",
      "dependsOn": [],
      "description": "As a user, I want minimal battery impact when the app is idle.",
      "acceptanceCriteria": [
        "Zero CPU usage when idle (no polling)",
        "Use event-based device monitoring",
        "Implement efficient hotkey detection (no busy loops)",
        "Make app App Nap compatible when possible",
        "Example: App idle -> Activity Monitor shows 0% CPU -> no energy impact",
        "Negative case: App Nap interferes with hotkey -> disable selectively"
      ]
    },
    {
      "id": "US-630",
      "title": "VoiceOver Support",
      "status": "open",
      "dependsOn": [],
      "description": "As a user with visual impairment, I want full VoiceOver accessibility.",
      "acceptanceCriteria": [
        "Add accessibility labels to all buttons",
        "Announce all status changes to VoiceOver",
        "Ensure keyboard navigation works everywhere",
        "Announce recording status changes",
        "Example: VoiceOver user navigates to Record button -> 'Record, button' announced",
        "Negative case: Custom view missing label -> provide fallback description"
      ]
    },
    {
      "id": "US-631",
      "title": "Localization Preparation",
      "status": "open",
      "dependsOn": [],
      "description": "As a developer, I want the app prepared for future localization.",
      "acceptanceCriteria": [
        "Move all user-facing strings to Localizable.strings",
        "Remove hardcoded strings from UI code",
        "Use locale-aware date/number formatting",
        "Design UI layouts to accommodate longer translated strings",
        "Example: String 'Start Recording' -> NSLocalizedString('start_recording', ...)",
        "Negative case: Missing localization key -> fall back to English"
      ]
    }
  ]
}
